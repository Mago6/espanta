// Validar fecha de inicio
function isValidDate(dateStr){
    if(!dateStr) return false;
    const d = new Date(dateStr);
    return d instanceof Date && !isNaN(d.getTime());
}

// Calcular semana real
function calculateWeek(start){
    if(!isValidDate(start)) return 1;
    const today = new Date();
    const startDate = new Date(start);
    if(today < startDate) return 0; // aún no inicia
    const diffDays = Math.floor((today - startDate)/(1000*60*60*24));
    const week = Math.floor(diffDays / 7) + 1;
    return week;
}

// Calcular etapa según semana real
function getStageName(week){
    if(week <= 1) return 'Germinación';
    if(week <= 3) return 'Plántula';
    if(week <= 7) return 'Vegetativo';
    if(week <= 9) return 'Floración media';
    if(week <= 11) return 'Floración final / Maduración';
    return 'Cosecha';
}

// Manejo de cambio de fecha de inicio
document.getElementById('applyStart').addEventListener('click',()=>{
    const val = startDateInput.value;
    if(!isValidDate(val)){
        alert('Fecha inválida. Por favor ingresa una fecha correcta.');
        startDateInput.value = plantsData[currentPlant].startDate;
        return;
    }
    plantsData[currentPlant].startDate = val;
    savePlantData(currentPlant);
    loadPlant(currentPlant);
});
