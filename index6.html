<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>25 Plantas - Calendario Diario</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background:#000; color:#f00; padding:10px; }
h2 { text-align:center; margin-bottom:15px; color:#f00; font-size:18px; }

.selection-panel { display:flex; gap:5px; flex-wrap:wrap; align-items:center; margin-bottom:10px; font-size:14px; }
.selection-panel select, .selection-panel input, .selection-panel button { padding:5px; border-radius:4px; border:1px solid #f00; background:#000; color:#f00; cursor:pointer; font-size:14px; }
.selection-panel button:hover, .selection-panel select:hover, .selection-panel input:hover { background:#f00; color:#000; }

.main-container { display:flex; flex-direction:column; gap:15px; align-items:center; }
.viewer-container { display:flex; flex-direction:column; align-items:center; gap:10px; width:100%; max-width:520px; }
.viewer { width:100%; max-width:500px; height:300px; background:#111; border-radius:12px; display:flex; align-items:center; justify-content:center; }
.plant-img { width:100%; height:100%; object-fit:contain; border-radius:8px; border:2px solid #f00; }

.npk-panel { display:flex; gap:5px; flex-wrap:wrap; justify-content:center; margin-top:5px; }
.npk-panel div { display:flex; flex-direction:column; align-items:center; }
.npk-panel input { width:70px; text-align:right; border-radius:4px; border:1px solid #f00; background:#000; color:#f00; }

#calendarContainer { margin-top:10px; display:flex; flex-direction:column; gap:5px; overflow-x:auto; width:100%; max-width:520px; }
.month-row { display:flex; gap:2px; flex-wrap:wrap; align-items:center; }
.month-label { width:50px; font-weight:bold; display:flex; align-items:center; justify-content:center; color:#f00; }
.day-box { width:35px; height:35px; display:flex; justify-content:center; align-items:center; border-radius:4px; font-size:10px; cursor:pointer; border:1px solid #f00; background:#111; color:#f00; }
.passed-day { background:green; color:#000; }
.current-day { border:2px solid #f00; background:#f00; color:#000; }

#infoSummary { margin-top:5px; font-size:14px; color:#0f0; text-align:center; }

#dashboard { display:none; margin-top:15px; width:100%; max-width:520px; }
.dashboard-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(90px,1fr)); gap:5px; }
.plant-card { padding:5px; border-radius:6px; background:#111; text-align:center; font-size:12px; display:flex; flex-direction:column; align-items:center; color:#f00; }
.plant-card img { width:70px; height:50px; object-fit:contain; border-radius:4px; margin-bottom:5px; border:1px solid #f00; }
</style>
</head>
<body>

<h2>25 Plantas - Calendario Diario</h2>

<div class="selection-panel">
  <label>Planta:</label>
  <select id="plantSelect"></select>
  <label>Fecha inicio:</label>
  <input type="date" id="startDate" min="2024-01-01">
  <label>Semana:</label>
  <input type="number" id="weekInput" min="1" max="52">
  <label>Etapa:</label>
  <select id="stageSelect">
    <option>Germinación</option>
    <option>Plántula</option>
    <option>Vegetativo</option>
    <option>Floración</option>
    <option>Cosecha</option>
  </select>
  <button id="updateBtn">Actualizar y Guardar Planta</button>
  <button id="showDashboard">Ver todas las plantas</button>
</div>

<div class="main-container">
  <div class="viewer-container">
    <div class="viewer">
      <img id="plantImg" class="plant-img" src="week01.webp" alt="Planta">
    </div>
    <div class="npk-panel">
      <div><label>Altura (cm):</label><input type="number" id="heightInput"></div>
      <div><label>N:</label><input type="number" id="nInput"></div>
      <div><label>P:</label><input type="number" id="pInput"></div>
      <div><label>K:</label><input type="number" id="kInput"></div>
    </div>
    <div id="infoSummary">
      <div id="weeksPassed"></div>
      <div id="weeksRemaining"></div>
      <div id="startDateInfo"></div>
      <div id="currentStageInfo"></div>
    </div>
  </div>
  <div id="calendarContainer"></div>
</div>

<div id="dashboard">
  <h3>Dashboard - Todas las plantas</h3>
  <div class="dashboard-grid" id="dashboardGrid"></div>
</div>

<script>
const NUM_PLANTS = 25;
const plantSelect = document.getElementById('plantSelect');
const stageSelect = document.getElementById('stageSelect');
const weekInput = document.getElementById('weekInput');
const plantImg = document.getElementById('plantImg');
const startDateInput = document.getElementById('startDate');
const heightInput = document.getElementById('heightInput');
const nInput = document.getElementById('nInput');
const pInput = document.getElementById('pInput');
const kInput = document.getElementById('kInput');
const calendarContainer = document.getElementById('calendarContainer');
const dashboard = document.getElementById('dashboard');
const dashboardGrid = document.getElementById('dashboardGrid');
const weeksPassedDiv = document.getElementById('weeksPassed');
const weeksRemainingDiv = document.getElementById('weeksRemaining');
const startDateInfoDiv = document.getElementById('startDateInfo');
const currentStageInfoDiv = document.getElementById('currentStageInfo');

let plantsData = {}, currentPlant = 'Planta01';

// Inicializar plantas
for (let i = 1; i <= NUM_PLANTS; i++) {
    const id = 'Planta' + String(i).padStart(2, '0');
    plantsData[id] = JSON.parse(localStorage.getItem(id)) || {
        startDate: (new Date()).toISOString().split('T')[0],
        week: 1,
        stage: 'Germinación',
        height: 0,
        nutrients: { n: 0, p: 0, k: 0 },
        history: []
    };
    const option = document.createElement('option'); option.value = id; option.textContent = id;
    plantSelect.appendChild(option);
}

// Función para determinar etapa según semana en ciclo anual
function getStageNameByWeek(week) {
    if (week <= 2) return 'Germinación';       // 0-10 días aprox
    if (week <= 6) return 'Plántula';         // 0.5-1.5 meses
    if (week <= 18) return 'Vegetativo';      // 1.5-3.5 meses
    if (week <= 26) return 'Floración';       // 3.5-6 meses
    return 'Cosecha';
}

// Imagen según semana (ajustada por ciclo anual)
function getImageForWeek(week) {
    if (week <= 2) return 'week01.webp';
    if (week <= 6) return `week0${week}.webp`;
    if (week <= 18) return `week0${week}.webp`;
    if (week <= 26) return `week0${week}.webp`;
    return 'week12.webp';
}

// Calcular semanas pasadas desde inicio
function calculateWeek(start) {
    const today = new Date();
    const startDate = new Date(start);
    const diffDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
    return Math.min(Math.ceil(diffDays / 7), 52);
}

// Generar calendario anual
function generateCalendar(plantId) {
    calendarContainer.innerHTML = '';
    const data = plantsData[plantId];
    const start = new Date(data.startDate);
    const today = new Date();
    let date = new Date(start);
    let monthStart = date.getMonth();
    let monthYear = date.getFullYear();
    let monthDays = [];

    for (let i = 0; i < 365; i++) {
        if (date.getMonth() !== monthStart) {
            appendMonth(monthYear, monthStart, monthDays, data, today);
            monthDays = [];
            monthStart = date.getMonth();
            monthYear = date.getFullYear();
        }
        const weekNum = Math.min(Math.ceil((date - start) / (1000 * 60 * 60 * 24 * 7)), 52);
        monthDays.push({ day: date.getDate(), week: weekNum, dateObj: new Date(date) });
        date.setDate(date.getDate() + 1);
    }
    if (monthDays.length > 0) appendMonth(monthYear, monthStart, monthDays, data, today);
}

function appendMonth(year, month, monthDays, data, today) {
    const monthRow = document.createElement('div'); monthRow.className = 'month-row';
    const monthLabel = document.createElement('div'); monthLabel.className = 'month-label';
    monthLabel.textContent = new Date(year, month).toLocaleString('es-ES', { month: 'short' });
    monthRow.appendChild(monthLabel);

    monthDays.forEach(d => {
        const box = document.createElement('div');
        box.className = 'day-box';
        box.textContent = d.day;
        if (d.dateObj < today) box.classList.add('passed-day');
        if (d.dateObj <= today && calculateWeek(data.startDate) === d.week) box.classList.add('current-day');
        monthRow.appendChild(box);
    });
    calendarContainer.appendChild(monthRow);
}

// Cargar planta
function loadPlant(id) {
    currentPlant = id;
    const data = plantsData[id];
    startDateInput.value = data.startDate;

    const weeksPassed = calculateWeek(data.startDate);
    data.week = weeksPassed;
    data.stage = getStageNameByWeek(weeksPassed);

    stageSelect.value = data.stage;
    weekInput.value = data.week;
    plantImg.src = getImageForWeek(data.week);
    heightInput.value = data.height;
    nInput.value = data.nutrients.n;
    pInput.value = data.nutrients.p;
    kInput.value = data.nutrients.k;

    const weeksRemaining = 52 - weeksPassed;

    weeksPassedDiv.textContent = `Semanas transcurridas: ${weeksPassed}`;
    weeksRemainingDiv.textContent = `Semanas restantes hasta cosecha: ${weeksRemaining}`;
    startDateInfoDiv.textContent = `Fecha de inicio: ${data.startDate}`;
    currentStageInfoDiv.textContent = `Etapa actual: ${data.stage}`;

    generateCalendar(id);
}

// Guardar planta
function savePlantData(id) {
    localStorage.setItem(id, JSON.stringify(plantsData[id]));
}

// Actualizar y guardar
document.getElementById('updateBtn').addEventListener('click', () => {
    const data = plantsData[currentPlant];
    if (new Date(startDateInput.value) < new Date('2024-01-01')) {
        alert('La fecha de inicio debe ser a partir del 01/01/2024');
        return;
    }
    data.startDate = startDateInput.value;
    data.week = parseInt(weekInput.value);
    data.stage = getStageNameByWeek(data.week);
    stageSelect.value = data.stage;
    data.height = parseFloat(heightInput.value);
    data.nutrients = { n: parseFloat(nInput.value), p: parseFloat(pInput.value), k: parseFloat(kInput.value) };
    plantsData[currentPlant] = data;
    savePlantData(currentPlant);
    loadPlant(currentPlant);
});

// Sincronizar semana y etapa
stageSelect.addEventListener('change', () => {
    const data = plantsData[currentPlant];
    switch (stageSelect.value) {
        case 'Germinación': data.week = 1; break;
        case 'Plántula': data.week = 3; break;
        case 'Vegetativo': data.week = 6; break;
        case 'Floración': data.week = 9; break;
        case 'Cosecha': data.week = 12; break;
    }
    data.stage = stageSelect.value;
    weekInput.value = data.week;
    plantsData[currentPlant] = data;
    savePlantData(currentPlant);
    loadPlant(currentPlant);
});

weekInput.addEventListener('change', () => {
    const data = plantsData[currentPlant];
    data.week = parseInt(weekInput.value);
    data.stage = getStageNameByWeek(data.week);
    stageSelect.value = data.stage;
    plantsData[currentPlant] = data;
    savePlantData(currentPlant);
    loadPlant(currentPlant);
});

// Cambiar planta
plantSelect.addEventListener('change', () => loadPlant(plantSelect.value));

// Dashboard
document.getElementById('showDashboard').addEventListener('click', () => {
    dashboard.style.display = 'block';
    dashboardGrid.innerHTML = '';
    for (let i = 1; i <= NUM_PLANTS; i++) {
        const id = 'Planta' + String(i).padStart(2, '0');
        const card = document.createElement('div'); card.className = 'plant-card';
        const img = document.createElement('img'); img.src = getImageForWeek(plantsData[id].week); card.appendChild(img);
        const label = document.createElement('div'); label.textContent = id; card.appendChild(label);
        card.onclick = () => { loadPlant(id); dashboard.style.display = 'none'; };
        dashboardGrid.appendChild(card);
    }
});

// Init
loadPlant('Planta01');
</script>
</body>
</html>
